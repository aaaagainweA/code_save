from process_r import process_run
from model_r import model_run
from predict_r import pre_run

# from process_v import process_run
# from model_v import model_run
# from predict_v import pre_run

# from process_c import process_run ###############需要修改的地方
# from model_c import model_run
# from predict_c import pre_run

# from process_k import process_run
# from model_k import model_run
# from predict_k import pre_run

import datetime as dt
from dateutil.relativedelta import relativedelta
import pgdb
import os
import pandas as pd
import time

def auto_run():
    #path='D:/rabit/1207'######
    #模块
    model_name = 'comb' #c\k\comb\v##############需要改的地方
    #c_ziduan
    # ziduan_list = ['prd_inst_id','c_num','billing_type_id','prd_id','std_prd_id','age','gender_id','latn_id','country_flag','channel_type_id','innet_dur','cluster_id','std_cluster_type_id','innet_flag','bil_flag','std_prd_inst_stat_name','ofr_id','ofr_amt','ofr_name_type','prom_type_name','merge_prom_id','merge_prom_type','std_prd_inst_property_id','std_owe_segment_id','pay_mode_id','act_flag','prd_inst_nbr','prd_inst_id_num','oper_type','oper_group','card_type','nbr_type','vip_flag','brand_id','brand_type_id','terminal_code','register_intel_flag','register_term_name','register_term_code','rgt_billing_cycle_id','register_term_price','rgt_term_dur','register_term_type','is_lte_card','jt_lte_flag','user_type_id','cde_lte_type_id','fuka_num','lte_card_dvlp_dur','apply_billing_cycle_id','apply_ofr_dur','cz_fee','inv_bill_amt','inv_amt','ofr_cz_fee','ofr_inv_amt','acct_balance_amount_0','acct_balance_amount_1','acct_balance_amount','pay_times','pay_amount','credit_value','credit_level','prd_cz_inv','ofr_cz_inv','ofr_inv_ofr_amt','owe_stop_times','owe_charge_times','fluxout_fee','flux_fee','call_fee','appr_fee','roam_fee','duration','total_flux','cz_fee_avg','cz_fee_stddev','cz_fee_max','cz_fee_min','cz_fee_dis','cz_fee_vot','cz_fee_lst','cz_fee_tlst','cz_fee_grow','inv_amt_avg','inv_amt_stddev','inv_amt_max','inv_amt_min','inv_amt_dis','inv_amt_vot','inv_amt_lst','inv_amt_tlst','inv_amt_grow','ofr_cz_fee_avg','ofr_cz_fee_stddev','ofr_cz_fee_max','ofr_cz_fee_min','ofr_cz_fee_dis','ofr_cz_fee_vot','ofr_cz_fee_lst','ofr_cz_fee_tlst','ofr_cz_fee_grow','ofr_inv_amt_avg','ofr_inv_amt_stddev','ofr_inv_amt_max','ofr_inv_amt_min','ofr_inv_amt_dis','ofr_inv_amt_vot','ofr_inv_amt_lst','ofr_inv_amt_tlst','ofr_inv_amt_grow','acct_balance_amount_avg','acct_balance_amount_stddev','acct_balance_amount_max','acct_balance_amount_min','acct_balance_amount_dis','acct_balance_amount_vot','acct_balance_amount_lst','acct_balance_amount_tlst','acct_balance_amount_grow','prd_cz_inv_avg','prd_cz_inv_stddev','prd_cz_inv_max','prd_cz_inv_min','prd_cz_inv_dis','prd_cz_inv_vot','prd_cz_inv_lst','prd_cz_inv_tlst','prd_cz_inv_grow','ofr_cz_inv_avg','ofr_cz_inv_stddev','ofr_cz_inv_max','ofr_cz_inv_min','ofr_cz_inv_dis','ofr_cz_inv_vot','ofr_cz_inv_lst','ofr_cz_inv_tlst','ofr_cz_inv_grow','ofr_inv_ofr_amt_avg','ofr_inv_ofr_amt_stddev','ofr_inv_ofr_amt_max','ofr_inv_ofr_amt_min','ofr_inv_ofr_amt_dis','ofr_inv_ofr_amt_vot','ofr_inv_ofr_amt_lst','ofr_inv_ofr_amt_tlst','ofr_inv_ofr_amt_grow','fluxout_fee_avg','fluxout_fee_stddev','fluxout_fee_max','fluxout_fee_min','fluxout_fee_dis','fluxout_fee_vot','fluxout_fee_lst','fluxout_fee_tlst','fluxout_fee_grow','flux_fee_avg','flux_fee_stddev','flux_fee_max','flux_fee_min','flux_fee_dis','flux_fee_vot','flux_fee_lst','flux_fee_tlst','flux_fee_grow','flux_fee_per','call_fee_avg','call_fee_stddev','call_fee_max','call_fee_min','call_fee_dis','call_fee_vot','call_fee_lst','call_fee_tlst','call_fee_grow','call_fee_per','appr_fee_avg','appr_fee_stddev','appr_fee_max','appr_fee_min','appr_fee_dis','appr_fee_vot','appr_fee_lst','appr_fee_tlst','appr_fee_grow','appr_fee_per','roam_fee_avg','roam_fee_stddev','roam_fee_max','roam_fee_min','roam_fee_dis','roam_fee_vot','roam_fee_lst','roam_fee_tlst','roam_fee_grow','roam_fee_per','acct_balance_amount_0_avg','acct_balance_amount_0_lst','acct_balance_amount_0_tlst','acct_balance_amount_0_grow','acct_balance_amount_1_avg','acct_balance_amount_1_lst','acct_balance_amount_1_tlst','acct_balance_amount_1_grow','pay_times_avg','pay_times_lst','pay_times_tlst','pay_times_grow','pay_amount_avg','pay_amount_lst','pay_amount_tlst','pay_amount_grow','owe_stop_times_avg','owe_stop_times_lst','owe_stop_times_tlst','owe_stop_times_grow','owe_charge_times_avg','owe_charge_times_lst','owe_charge_times_tlst','owe_charge_times_grow','flux_2306','flux_0612','flux_1218','flux_1823','flux_n4g','flux_4g','total_flux_avg','total_flux_stddev','total_flux_max','total_flux_min','total_flux_dis','total_flux_vot','total_flux_lst','total_flux_tlst','total_flux_grow','flux_4g_avg','flux_4g_stddev','flux_4g_max','flux_4g_min','flux_4g_dis','flux_4g_vot','flux_4g_lst','flux_4g_tlst','flux_4g_grow','flux_4g_per','flux_n4g_avg','flux_n4g_stddev','flux_n4g_max','flux_n4g_min','flux_n4g_dis','flux_n4g_vot','flux_n4g_lst','flux_n4g_tlst','flux_n4g_grow','flux_n4g_per','flux_0612_avg','flux_0612_per','flux_0612_grow','flux_1218_avg','flux_1218_per','flux_1218_grow','flux_1823_avg','flux_1823_per','flux_1823_grow','flux_2306_avg','flux_2306_per','flux_2306_grow','total_dur','total_cnt','call_dur','call_cnt','called_dur','called_cnt','roam_99_dur','roam_99_cnt','roam_10_dur','roam_10_cnt','roam_20_dur','roam_20_cnt','roam_oth_dur','roam_oth_cnt','call_0612_dur','call_0612_cnt','call_1218_dur','call_1218_cnt','call_1823_dur','call_1823_cnt','call_2306_dur','call_2306_cnt','call_workday_dur','call_workday_cnt','call_weekend_dur','call_weekend_cnt','call_10_dur','call_10_cnt','call_11_dur','call_11_cnt','call_12_dur','call_12_cnt','call_n10_dur','call_n10_cnt','total_dur_avg','total_dur_stddev','total_dur_max','total_dur_min','total_dur_dis','total_dur_vot','total_dur_lst','total_dur_tlst','total_dur_grow','total_cnt_avg','total_cnt_stddev','total_cnt_max','total_cnt_min','total_cnt_dis','total_cnt_vot','total_cnt_lst','total_cnt_tlst','total_cnt_grow','call_dur_avg','call_dur_stddev','call_dur_max','call_dur_min','call_dur_dis','call_dur_vot','call_dur_lst','call_dur_tlst','call_dur_grow','call_dur_per','call_cnt_avg','call_cnt_stddev','call_cnt_max','call_cnt_min','call_cnt_dis','call_cnt_vot','call_cnt_lst','call_cnt_tlst','call_cnt_grow','call_cnt_per','called_dur_avg','called_dur_per','called_dur_grow','called_cnt_avg','called_cnt_per','called_cnt_grow','roam_99_dur_avg','roam_99_dur_per','roam_99_dur_grow','roam_99_cnt_avg','roam_99_cnt_per','roam_99_cnt_grow','roam_10_dur_avg','roam_10_dur_per','roam_10_dur_grow','roam_10_cnt_avg','roam_10_cnt_per','roam_10_cnt_grow','roam_20_dur_avg','roam_20_dur_per','roam_20_dur_grow','roam_20_cnt_avg','roam_20_cnt_per','roam_20_cnt_grow','roam_oth_dur_avg','roam_oth_dur_per','roam_oth_dur_grow','roam_oth_cnt_avg','roam_oth_cnt_per','roam_oth_cnt_grow','call_0612_dur_avg','call_0612_dur_per','call_0612_dur_grow','call_0612_cnt_avg','call_0612_cnt_per','call_0612_cnt_grow','call_1218_dur_avg','call_1218_dur_per','call_1218_dur_grow','call_1218_cnt_avg','call_1218_cnt_per','call_1218_cnt_grow','call_1823_dur_avg','call_1823_dur_per','call_1823_dur_grow','call_1823_cnt_avg','call_1823_cnt_per','call_1823_cnt_grow','call_2306_dur_avg','call_2306_dur_per','call_2306_dur_grow','call_2306_cnt_avg','call_2306_cnt_per','call_2306_cnt_grow','call_workday_dur_avg','call_workday_dur_per','call_workday_dur_grow','call_workday_cnt_avg','call_workday_cnt_per','call_workday_cnt_grow','call_weekend_dur_avg','call_weekend_dur_per','call_weekend_dur_grow','call_weekend_cnt_avg','call_weekend_cnt_per','call_weekend_cnt_grow','call_10_dur_avg','call_10_dur_per','call_10_dur_grow','call_10_cnt_avg','call_10_cnt_per','call_10_cnt_grow','call_12_dur_avg','call_12_dur_per','call_12_dur_grow','call_12_cnt_avg','call_12_cnt_per','call_12_cnt_grow','call_11_dur_avg','call_11_dur_per','call_11_dur_grow','call_11_cnt_avg','call_11_cnt_per','call_11_cnt_grow','call_n10_dur_avg','call_n10_dur_per','call_n10_dur_grow','call_n10_cnt_avg','call_n10_cnt_per','call_n10_cnt_grow','total_cnt total_sms_cnt','opp10_cnt','oth_cnt','change_flag']
    #v_ziduan
    # ziduan_list = ['prd_inst_id','is3g_flag','intel_flag','phone_brand_id','phone_type_id','firm','phone_price_yuan','cdma_1x','operating_sys','feature_tag','mob_type','comp_flag','screens_nbr','main_screen_size','baseband_chip_clocked','resolution','ram','main_camera','terminal_type','is4g_flag','c_num','billing_type_id','prd_id','std_prd_id','age','gender_id','latn_id','country_flag','channel_type_id','innet_dur','cluster_id','std_cluster_type_id','innet_flag','bil_flag','std_prd_inst_stat_name','ofr_id','ofr_amt','ofr_name_type','prom_type_name','merge_prom_id','merge_prom_type','std_prd_inst_property_id','std_owe_segment_id','pay_mode_id','act_flag','prd_inst_nbr','prd_inst_id_num','oper_type','oper_group','card_type','nbr_type','vip_flag','brand_id','brand_type_id','terminal_code','register_intel_flag','register_term_name','register_term_code','rgt_billing_cycle_id','register_term_price','rgt_term_dur','register_term_type','is_lte_card','jt_lte_flag','user_type_id','cde_lte_type_id','fuka_num','lte_card_dvlp_dur','apply_billing_cycle_id','apply_ofr_dur','cz_fee','inv_bill_amt','inv_amt','ofr_cz_fee','ofr_inv_amt','acct_balance_amount_0','acct_balance_amount_1','acct_balance_amount','pay_times','pay_amount','credit_value','credit_level','prd_cz_inv','ofr_cz_inv','ofr_inv_ofr_amt','owe_stop_times','owe_charge_times','fluxout_fee','flux_fee','call_fee','appr_fee','roam_fee','duration','total_flux','cz_fee_avg','cz_fee_stddev','cz_fee_max','cz_fee_min','cz_fee_dis','cz_fee_vot','cz_fee_lst','cz_fee_tlst','cz_fee_grow','inv_amt_avg','inv_amt_stddev','inv_amt_max','inv_amt_min','inv_amt_dis','inv_amt_vot','inv_amt_lst','inv_amt_tlst','inv_amt_grow','ofr_cz_fee_avg','ofr_cz_fee_stddev','ofr_cz_fee_max','ofr_cz_fee_min','ofr_cz_fee_dis','ofr_cz_fee_vot','ofr_cz_fee_lst','ofr_cz_fee_tlst','ofr_cz_fee_grow','ofr_inv_amt_avg','ofr_inv_amt_stddev','ofr_inv_amt_max','ofr_inv_amt_min','ofr_inv_amt_dis','ofr_inv_amt_vot','ofr_inv_amt_lst','ofr_inv_amt_tlst','ofr_inv_amt_grow','acct_balance_amount_avg','acct_balance_amount_stddev','acct_balance_amount_max','acct_balance_amount_min','acct_balance_amount_dis','acct_balance_amount_vot','acct_balance_amount_lst','acct_balance_amount_tlst','acct_balance_amount_grow','prd_cz_inv_avg','prd_cz_inv_stddev','prd_cz_inv_max','prd_cz_inv_min','prd_cz_inv_dis','prd_cz_inv_vot','prd_cz_inv_lst','prd_cz_inv_tlst','prd_cz_inv_grow','ofr_cz_inv_avg','ofr_cz_inv_stddev','ofr_cz_inv_max','ofr_cz_inv_min','ofr_cz_inv_dis','ofr_cz_inv_vot','ofr_cz_inv_lst','ofr_cz_inv_tlst','ofr_cz_inv_grow','ofr_inv_ofr_amt_avg','ofr_inv_ofr_amt_stddev','ofr_inv_ofr_amt_max','ofr_inv_ofr_amt_min','ofr_inv_ofr_amt_dis','ofr_inv_ofr_amt_vot','ofr_inv_ofr_amt_lst','ofr_inv_ofr_amt_tlst','ofr_inv_ofr_amt_grow','fluxout_fee_avg','fluxout_fee_stddev','fluxout_fee_max','fluxout_fee_min','fluxout_fee_dis','fluxout_fee_vot','fluxout_fee_lst','fluxout_fee_tlst','fluxout_fee_grow','flux_fee_avg','flux_fee_stddev','flux_fee_max','flux_fee_min','flux_fee_dis','flux_fee_vot','flux_fee_lst','flux_fee_tlst','flux_fee_grow','flux_fee_per','call_fee_avg','call_fee_stddev','call_fee_max','call_fee_min','call_fee_dis','call_fee_vot','call_fee_lst','call_fee_tlst','call_fee_grow','call_fee_per','appr_fee_avg','appr_fee_stddev','appr_fee_max','appr_fee_min','appr_fee_dis','appr_fee_vot','appr_fee_lst','appr_fee_tlst','appr_fee_grow','appr_fee_per','roam_fee_avg','roam_fee_stddev','roam_fee_max','roam_fee_min','roam_fee_dis','roam_fee_vot','roam_fee_lst','roam_fee_tlst','roam_fee_grow','roam_fee_per','acct_balance_amount_0_avg','acct_balance_amount_0_lst','acct_balance_amount_0_tlst','acct_balance_amount_0_grow','acct_balance_amount_1_avg','acct_balance_amount_1_lst','acct_balance_amount_1_tlst','acct_balance_amount_1_grow','pay_times_avg','pay_times_lst','pay_times_tlst','pay_times_grow','pay_amount_avg','pay_amount_lst','pay_amount_tlst','pay_amount_grow','owe_stop_times_avg','owe_stop_times_lst','owe_stop_times_tlst','owe_stop_times_grow','owe_charge_times_avg','owe_charge_times_lst','owe_charge_times_tlst','owe_charge_times_grow','flux_2306','flux_0612','flux_1218','flux_1823','flux_n4g','flux_4g','total_flux_avg','total_flux_stddev','total_flux_max','total_flux_min','total_flux_dis','total_flux_vot','total_flux_lst','total_flux_tlst','total_flux_grow','flux_4g_avg','flux_4g_stddev','flux_4g_max','flux_4g_min','flux_4g_dis','flux_4g_vot','flux_4g_lst','flux_4g_tlst','flux_4g_grow','flux_4g_per','flux_n4g_avg','flux_n4g_stddev','flux_n4g_max','flux_n4g_min','flux_n4g_dis','flux_n4g_vot','flux_n4g_lst','flux_n4g_tlst','flux_n4g_grow','flux_n4g_per','flux_0612_avg','flux_0612_per','flux_0612_grow','flux_1218_avg','flux_1218_per','flux_1218_grow','flux_1823_avg','flux_1823_per','flux_1823_grow','flux_2306_avg','flux_2306_per','flux_2306_grow','total_dur','total_cnt','call_dur','call_cnt','called_dur','called_cnt','roam_99_dur','roam_99_cnt','roam_10_dur','roam_10_cnt','roam_20_dur','roam_20_cnt','roam_oth_dur','roam_oth_cnt','call_0612_dur','call_0612_cnt','call_1218_dur','call_1218_cnt','call_1823_dur','call_1823_cnt','call_2306_dur','call_2306_cnt','call_workday_dur','call_workday_cnt','call_weekend_dur','call_weekend_cnt','call_10_dur','call_10_cnt','call_11_dur','call_11_cnt','call_12_dur','call_12_cnt','call_n10_dur','call_n10_cnt','total_dur_avg','total_dur_stddev','total_dur_max','total_dur_min','total_dur_dis','total_dur_vot','total_dur_lst','total_dur_tlst','total_dur_grow','total_cnt_avg','total_cnt_stddev','total_cnt_max','total_cnt_min','total_cnt_dis','total_cnt_vot','total_cnt_lst','total_cnt_tlst','total_cnt_grow','call_dur_avg','call_dur_stddev','call_dur_max','call_dur_min','call_dur_dis','call_dur_vot','call_dur_lst','call_dur_tlst','call_dur_grow','call_dur_per','call_cnt_avg','call_cnt_stddev','call_cnt_max','call_cnt_min','call_cnt_dis','call_cnt_vot','call_cnt_lst','call_cnt_tlst','call_cnt_grow','call_cnt_per','called_dur_avg','called_dur_per','called_dur_grow','called_cnt_avg','called_cnt_per','called_cnt_grow','roam_99_dur_avg','roam_99_dur_per','roam_99_dur_grow','roam_99_cnt_avg','roam_99_cnt_per','roam_99_cnt_grow','roam_10_dur_avg','roam_10_dur_per','roam_10_dur_grow','roam_10_cnt_avg','roam_10_cnt_per','roam_10_cnt_grow','roam_20_dur_avg','roam_20_dur_per','roam_20_dur_grow','roam_20_cnt_avg','roam_20_cnt_per','roam_20_cnt_grow','roam_oth_dur_avg','roam_oth_dur_per','roam_oth_dur_grow','roam_oth_cnt_avg','roam_oth_cnt_per','roam_oth_cnt_grow','call_0612_dur_avg','call_0612_dur_per','call_0612_dur_grow','call_0612_cnt_avg','call_0612_cnt_per','call_0612_cnt_grow','call_1218_dur_avg','call_1218_dur_per','call_1218_dur_grow','call_1218_cnt_avg','call_1218_cnt_per','call_1218_cnt_grow','call_1823_dur_avg','call_1823_dur_per','call_1823_dur_grow','call_1823_cnt_avg','call_1823_cnt_per','call_1823_cnt_grow','call_2306_dur_avg','call_2306_dur_per','call_2306_dur_grow','call_2306_cnt_avg','call_2306_cnt_per','call_2306_cnt_grow','call_workday_dur_avg','call_workday_dur_per','call_workday_dur_grow','call_workday_cnt_avg','call_workday_cnt_per','call_workday_cnt_grow','call_weekend_dur_avg','call_weekend_dur_per','call_weekend_dur_grow','call_weekend_cnt_avg','call_weekend_cnt_per','call_weekend_cnt_grow','call_10_dur_avg','call_10_dur_per','call_10_dur_grow','call_10_cnt_avg','call_10_cnt_per','call_10_cnt_grow','call_12_dur_avg','call_12_dur_per','call_12_dur_grow','call_12_cnt_avg','call_12_cnt_per','call_12_cnt_grow','call_11_dur_avg','call_11_dur_per','call_11_dur_grow','call_11_cnt_avg','call_11_cnt_per','call_11_cnt_grow','call_n10_dur_avg','call_n10_dur_per','call_n10_dur_grow','call_n10_cnt_avg','call_n10_cnt_per','call_n10_cnt_grow','total_cnt total_sms_cnt','opp10_cnt','oth_cnt','change_flag']
    #r_ziduan
    ziduan_list = ['prd_inst_id','c_num','k_num','billing_type_id','prd_id','std_prd_id','age','gender_id','latn_id','country_flag','channel_type_id','innet_dur','cluster_id','std_cluster_type_id','innet_flag','bil_flag','std_prd_inst_stat_name','ofr_id','ofr_name','ofr_amt','ofr_name_type','prom_type_name','merge_prom_id','merge_prom_type','std_prd_inst_property_id','std_owe_segment_id','pay_mode_id','act_flag','prd_inst_nbr','prd_inst_id_num','oper_type','oper_group','card_type','nbr_type','vip_flag','brand_id','brand_type_id','terminal_code','register_intel_flag','register_term_name','register_term_code','rgt_billing_cycle_id','register_term_price','rgt_term_dur','register_term_type','is_lte_card','jt_lte_flag','user_type_id','cde_lte_type_id','fuka_num','lte_card_dvlp_dur','apply_billing_cycle_id','apply_ofr_dur','ofr_cz_fee','ofr_inv_amt','acct_balance_amount_0','acct_balance_amount_1','acct_balance_amount','pay_times','pay_amount','credit_value','credit_level','prd_cz_inv','ofr_cz_inv','ofr_inv_ofr_amt','owe_stop_times','owe_charge_times','fluxout_fee','flux_fee','call_fee','appr_fee','roam_fee','duration','total_flux','fluxout_fee_min','fluxout_fee_max','fluxout_fee_avg','fluxout_fee_lst','fluxout_fee_tlst','fluxout_fee_grow','fluxout_fee_std','fluxout_fee_dis','fluxout_fee_vot','flux_fee_min','flux_fee_max','flux_fee_avg','flux_fee_lst','flux_fee_tlst','flux_fee_grow','flux_fee_std','pay_amount_dis','flux_fee_vot','call_fee_min','call_fee_max','call_fee_avg','call_fee_lst','call_fee_tlst','call_fee_grow','call_fee_std','call_fee_dis','call_fee_vot','appr_fee_min','appr_fee_max','appr_fee_avg','appr_fee_lst','appr_fee_tlst','appr_fee_grow','appr_fee_std','appr_fee_dis','appr_fee_vot','roam_fee_min','roam_fee_max','roam_fee_avg','roam_fee_lst','roam_fee_tlst','roam_fee_grow','roam_fee_std','roam_fee_dis','roam_fee_vot','duration_min','duration_max','duration_avg','duration_lst','duration_tlst','duration_grow','duration_std','duration_dis','duration_vot','total_flux_min','total_flux_max','total_flux_avg','total_flux_lst','total_flux_tlst','total_flux_grow','total_flux_std','total_flux_dis','total_flux_vot','change_flag']
    #k_ziduan
    # ziduan_list = ['prd_inst_id','pay_flag','acc_type','accs_mode_cd','line_rate','year_charge','pro_prtl_mons','trmnl_type_cd','oper_type','ofr_id','ofr_name','ref_type','std_prd_inst_stat_name','std_prd_inst_property_name','cz_fee','latn_id','country_flag','vip_flag','prd_inst_nbr','strategy_segment_id','innet_dur','prd_inst_stat_unorm_6','prd_inst_stat_unorm_3','month_rest','broadband_ticket_flag','merge_prom_id','std_quality_type_id','billing_type_id','cs_hnd_cnt','prd_struc_type','cluster_no','r3m_remove_cnt','r3m_add_cnt','cust_owe_amt','cust_inv_amt','owe_flg','owe_amt','inv_amt','age_seg','cs_other_cnt','v3_net_days','v3_content_type','on_net_month','cdsc_type_name','stop_dur','cust_o_ctc_lcl_dur','cust_roam_dur','cust_o_tol_dur','cs_cpl_cnt','cs_oper_cnt','cs_conslt_cnt','total_dur','total_flux','total_cnt','up_flux','down_flux','total_flux_d1','total_flux_d2','total_flux_d3','total_cnt_d1','total_cnt_d2','total_cnt_d3','total_dur_d1','total_dur_d2','total_dur_d3','total_flux_h1','total_flux_h2','total_flux_h3','total_flux_h4','total_dur_h1','total_dur_h2','total_dur_h3','total_dur_h4','total_dur_avg','total_dur_lst','total_dur_tlst','total_dur_grow','total_dur_std','total_dur_dis','total_dur_vot','total_dur_d1_avg','total_dur_d2_avg','total_dur_d3_avg','total_dur_d1_avg_per','total_dur_d2_avg_per','total_dur_d3_avg_per','total_dur_h1_avg','total_dur_h2_avg','total_dur_h3_avg','total_dur_h4_avg','total_dur_h1_avg_per','total_dur_h2_avg_per','total_dur_h3_avg_per','total_dur_h4_avg_per','total_flux_avg','total_flux_lst','total_flux_tlst','total_flux_grow','total_flux_std','total_flux_dis','total_flux_vot','total_flux_d1_avg','total_flux_d2_avg','total_flux_d3_avg','total_flux_d1_avg_per','total_flux_d2_avg_per','total_flux_d3_avg_per','total_flux_h1_avg','total_flux_h2_avg','total_flux_h3_avg','total_flux_h4_avg','total_flux_h1_avg_per','total_flux_h2_avg_per','total_flux_h3_avg_per','total_flux_h4_avg_per','total_cnt_avg','total_cnt_lst','total_cnt_tlst','total_cnt_grow','total_cnt_std','total_cnt_dis','total_cnt_vot','total_cnt_d1_avg','total_cnt_d2_avg','total_cnt_d3_avg','total_cnt_d1_avg_per','total_cnt_d2_avg_per','total_cnt_d3_avg_per','if_owe','account_month','pay_month','owe_month','recv_amt','recv_amt_min','recv_amt_max','recv_amt_avg','recv_amt_lst','recv_amt_tlst','recv_amt_grow','recv_amt_std','recv_amt_dis','recv_amt_vot','pay_amount','pay_amount_min','pay_amount_max','pay_amount_avg','pay_amount_lst','pay_amount_tlst','pay_amount_grow','pay_amount_std','pay_amount_dis','pay_amount_vot','pay_times','pay_times_min','pay_times_max','pay_times_avg','pay_times_lst','pay_times_tlst','pay_times_grow','pay_times_std','pay_times_dis','pay_times_vot','in_owe_charge','in_owe_charge_min','in_owe_charge_max','in_owe_charge_avg','in_owe_charge_lst','in_owe_charge_tlst','in_owe_charge_grow','in_owe_charge_std','in_owe_charge_dis','in_owe_charge_vot','change_flag']

    n_ym = dt.datetime.now().strftime('%Y%m')#本月年月
    #获取当前路径
    dir_str = os.path.dirname(os.path.realpath(__file__))
    path = dir_str.rstrip('\\code')
    print(path)

    #查看文件夹有没有，有就连文件夹及里的文件全部删掉
    #cmd_str = '"D:\WinSCP\WinSCP.exe" /console /command "option confirm off" "open gpadmin:gpadmin@133.0.123.129" "rmdir /home/gpadmin/CDR/jian/'+model_name+'/"  "mkdir /home/gpadmin/CDR/jian/'+model_name+'/" "exit"'
    #cmd_str = 'ssh gpadmin@133.0.123.129 "[ -d /home/gpadmin/CDR/jian/'+model_name+'] && rm -rf /home/gpadmin/CDR/jian/'+model_name+'"'
    #print(cmd_str)
    os.popen('ssh gpadmin@133.0.123.129 "[ -d /home/gpadmin/CDR/jian/'+model_name+' ] && rm -rf /home/gpadmin/CDR/jian/'+model_name+'"')
    print('ssh ...@xx.x.x.x "[ -d /home/gpadmin/CDR/jian/'+model_name+' ] && rm -rf /home/gpadmin/CDR/jian/'+model_name+'"')
    time.sleep(8)
    #再建一个空文件夹
    os.popen('ssh gpadmin@133.0.123.129 "mkdir /home/gpadmin/CDR/jian/'+model_name+'"')
    print('ssh ...@xx.x.x.x "mkdir /home/gpadmin/CDR/jian/'+model_name+'"')
    time.sleep(5)
    #print('"D:\Program Files (x86)\WinSCP\WinSCP.exe" /console /command "option confirm off" "open gpadmin:gpadmin@133.0.123.129" "mkdir /home/gpadmin/CDR/jian/'+model_name+'/" "exit"')
    #os.popen('"D:\Program Files (x86)\WinSCP\WinSCP.exe" /console /command "option confirm off" "open gpadmin:gpadmin@133.0.123.129" "mkdir /home/gpadmin/CDR/jian/'+model_name+'/" "exit"')
    
    sql_str = "select distinct model_flag from dm."+model_name+"_to_comb_mod_"+n_ym

    myConnection = pgdb.connect(database='hbtms',user='gpadmin',password='Ifudata2018',host='133.0.123.129',port='5432') 

    models = pd.read_sql(sql_str,myConnection)
    #从数据库导出数据，并导出到本地
    cur = myConnection.cursor()
    models = models['model_flag'].dropna()
    models = models.astype('int').values
    mod_ziduan = ziduan_list.copy()
    ziduan_list.remove('change_flag')
    pre_ziduan = ziduan_list
    for model_i in models:
        #print("copy(select "+','.join(ziduan_list)+" from dm."+model_name+"_to_comb_mod_"+n_ym+" where model_flag="+str(model_i)+")to '/home/gpadmin/CDR/jian/"+model_name+"/"+model_name+"zr_"+n_ym+"_"+str(model_i)+".csv' with header delimiter  '|' CSV  null as '';")
        cur.execute("copy(select "+','.join(mod_ziduan)+" from dm."+model_name+"_to_comb_mod_"+n_ym+" where model_flag="+str(model_i)+")to '/home/gpadmin/CDR/jian/"+model_name+"/"+model_name+"zr_"+n_ym+"_"+str(model_i)+".csv' with header delimiter  '|' CSV  null as '';")
        cur.execute("copy(select "+','.join(pre_ziduan)+" from dm."+model_name+"_to_comb_pre_"+n_ym+" where model_flag="+str(model_i)+")to '/home/gpadmin/CDR/jian/"+model_name+"/"+model_name+"zr_"+n_ym+"_"+str(model_i)+"_pre.csv' with header delimiter  '|' CSV  null as '';")
        print('--mod and pre files', model_i ,'gbtolinux over...')
        time.sleep(20)
        #print('"D:\Program Files (x86)\WinSCP\WinSCP.exe" /console /command "option confirm off" "open gpadmin:gpadmin@133.0.123.129" "get /home/gpadmin/CDR/jian/'+model_name+'/'+model_name+'zr_'+n_ym+'_'+str(model_i)+'.csv '+dir_str.rstrip('code')+'data\\" "exit"')
        #这个地方不能用os.system，要用os.popen带返回值的
        os.popen('scp gpadmin@133.0.123.129:/home/gpadmin/CDR/jian/'+model_name+'/'+model_name+'zr_'+n_ym+'_'+str(model_i)+'.csv '+dir_str.rstrip('code')+'data\\')
        os.popen('scp gpadmin@133.0.123.129:/home/gpadmin/CDR/jian/'+model_name+'/'+model_name+'zr_'+n_ym+'_'+str(model_i)+'_pre.csv '+dir_str.rstrip('code')+'data\\')
        print('--mod and pre files', model_i ,'linuxtowindow over...')

    cur.close()

    #为防止没拷贝完，暂停30秒
    time.sleep(20)
    #处理
    for model_i in models:
        model_no = model_name+"zr_"+n_ym+"_"+str(model_i)
        process_run(model_no,path)
        print(model_no,'process over!')
        model_run(model_no,path+'/')
        print(model_no,'model over!')
        target=['change_flag']
        key=['prd_inst_id']
        pre_run(model_no,path+'/',target,key)
        print(model_no,'pre over!')
        #拷贝到服务器
        os.popen('scp '+dir_str.rstrip('code')+'data/output/predict_rs_'+model_name+'zr_'+n_ym+'_'+str(model_i)+'.csv gpadmin@133.0.123.129:/home/gpadmin/CDR/jian/'+model_name+'/')
        #time.sleep(20)

    #建表
    time.sleep(10)
    cur = myConnection.cursor()
    cur.execute("create table dm."+model_name+"_to_comb_rs_"+n_ym+" (prd_inst_id numeric(20,8),score decimal(30,2),model_flag integer) with (appendonly=true, compresstype=QUICKLZ,COMPRESSLEVEL=1) DISTRIBUTED BY (prd_inst_id);")
    for model_i in models:
        cur.execute("create table stg."+model_name+"_to_comb_rs_linshi_"+n_ym+" (prd_inst_id numeric(20,8),score decimal(30,2)) with (appendonly=true, compresstype=QUICKLZ,COMPRESSLEVEL=1) DISTRIBUTED BY (prd_inst_id);")

        print("COPY stg."+model_name+"_to_comb_rs_linshi_"+n_ym+" FROM '/home/gpadmin/CDR/jian/"+model_name+"/predict_rs_"+model_name+"zr_"+n_ym+"_"+str(model_i)+".csv' DELIMITERS ',' CSV  header  null as '';")
        cur.execute("COPY stg."+model_name+"_to_comb_rs_linshi_"+n_ym+" FROM '/home/gpadmin/CDR/jian/"+model_name+"/predict_rs_"+model_name+"zr_"+n_ym+"_"+str(model_i)+".csv' DELIMITERS ',' CSV  header  null as '';")
        print(cur.rowcount)
        print('--rs files', model_i ,'linuxtogp over...')
        print("insert into dm."+model_name+"_to_comb_rs_"+n_ym+" select *,"+str(model_i)+" model_flag from stg."+model_name+"_to_comb_rs_linshi_"+n_ym)
        cur.execute("insert into dm."+model_name+"_to_comb_rs_"+n_ym+" select *,"+str(model_i)+" model_flag from stg."+model_name+"_to_comb_rs_linshi_"+n_ym)
        
        cur.execute("drop table  stg."+model_name+"_to_comb_rs_linshi_"+n_ym)
        print('--rs files', model_i ,'merge over...')
    cur.close()
    myConnection.commit()
    myConnection.close()
        

auto_run()
    
    
